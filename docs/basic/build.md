---
title: 构建
layout: doc
navbar: true
sidebar: true
aside: true
outline: deep
lastUpdated: true
editLink: true
footer: true
---

# 构建

## 编译流程

1. 预处理: 处理代码中的所有预处理指令, 例如`#include`和`#define`等. 将这些指令替换成对应的代码, 生成一个新的文本文件, 作为编译器的输入. 在预处理的过程中, 还会进行条件编译, 即根据条件来选择是否编译某些代码块. 预处理完成之后, 会生成一个没有宏定义和条件编译的中间文件. 
    ::: tip
    `#include <stdio.h>`类似的`.h`头文件中只是包含了库函数的声明, 而不是具体的实现, 函数的具体实现存储在动态库(`.so`或`.dll`文件)或静态库(`.a`或`.lib`文件)中. 具体请见链接.
2. 编译: 编译器将代码进行词法, 语法和语义分析, 转化为中间代码. 中间代码是比汇编语言更加高级的表示, 便于优化和移植. 在编译的最后阶段, 编译器会对中间代码进行优化处理, 生成汇编代码, 将其编译成独立的对象文件. 对象文件中包含了当前模块的二进制代码和未定义的符号引用(例如调用的外部库函数, `printf`...), 这些未定义的引用会在后续链接阶段解析
3. 汇编: 中间代码会被汇编器转化为机器指令, 这些指令可以被计算机直接执行. 这个阶段生成的代码会以目标文件的形式存储, 等待连接阶段的处理
4. 链接: 将所有生成的目标文件和已有的库文件合并, 解决各个文件之间的符号引用, 生成最终的可执行文件. 

   每个目标文件(如`.o`)文件都包含了符号表, 记录了函数和全局变量的定义和引用. 符号分为两类: 已定义符号和未定义符号, 前者表示当前目标文件中已经实现的函数和变量, 后者表示的是当前目标文件中引用但是未定义的符号, 需要在其他目标文件或者库文件中查找, 链接器将解析这些符号, 确保每个未定义符号都能在其他文件中找到定义, 否则报错. 

   链接方式分为动态链接和静态链接, 静态链接是在链接阶段将库文件中的代码复制到可执行文件中, 静态库通常以`.a`(Linux)或`.lib`(Windows)为后缀. 它的有点是可执行文件不依赖外部库, 运行的时候无需加载其他文件, 每个程序包含所需的所有代码, 移植性强. 缺点是静态链接后产生的可执行文件的体积较大. 因为每个程序都包含库代码的副本. 更新库的时候, 需要重新链接. 动态链接不将库代码复制到可执行文件中. 动态库文件通常以`.so`或`.dll`(Windows)为后缀. 优点是可执行文件体积小, 不包含库代码的副本. 多个程序可以共享同一个动态库节省内存. 更新库的时候无需重新链接, 只需要替换库文件. 缺点是运行的时候需要加载动态库, 如果库版本不兼容(例如换了一台电脑, 操作系统)可能导致程序奔溃或者功能错误.

## 工具链

### MSVC和Windows SDK

在Windows上进行开发C/C++开发, MSVC(Microsoft Visual C++)和Windows SDK是必不可少的工具, 这两个工具各有特定的职责和作用.

MSVC是Microsoft提供的一套C/C++开发工具链, 包含了一系列支持编译, 链接, 调试等工具. MSVC并不是单一的编译器或者链接器, 而是一个工具集, 涵盖了从源代码到可执行文件的多个开发环节. 主要组件包括:

- `cl.exe`(编译器): 用于控制C和C++编译器和链接器的行为, 虽然它被称作是"编译器", 但是它也能调用链接器完成整个编译-链接过程
- `link.exe`(链接器): 可以独立运行, 直接处理`.obj`文件和库文件, 而不必通过`cl.exe`调用. 这种分离让链接器具备更大的灵活性, 便于处理不同的链接需求

使用`cl.exe`和`link.exe`的工作流程:

- 仅编译: `cl.exe /c filename.c`, 生成`.obj`文件而不链接
- 编译并链接: `cl.exe filename.c`, 自动帮你调用`link.exe`完成编译和链接, 生成可执行文件

除了编译器和链接器, 还提供了C/C++运行时库, 调试器(如`cdb.exe`), 代码分析工具等, 这些工具为开发过程中的调试, 性能分析提供了支持.

Windows SDK提供了Windows平台特有的库文件, 头文件和元数据, 是Windows应用开发的重要组成部分, 主要内容有:

- 头文件和库文件: Windows SDK提供了Windows API的头文件和库文件, 如`windows.h`, `user32.lib`, `kernel32.lib`等, 允许开发者调用Windows系统的底层功能, 如窗口管理, 文件I/O, 网络等
- 元数据和工具: Windows SDK包含UWP(通用Windows平台)和Win32应用程序的工具集. 适用于不同Windows版本的SDK会包含特定的API版本和平台支持, 例如最新的Windows11 SDK会提供一下Windows10没有的API.

::: tip
MSVC中包含的运行时库和Windows SDK库有显著区别:

- MSVC运行时库: 主要为C/C++应用程序提供标准库的功能, 如基本的输入输出, 内存管理, 数学运算, 错误处理等. 如`prinf`, `malloc`, `free`等函数的实现
- Windows SDK: 提供与Windows操作系统直接交互的API, 支持Windows特定的功能, 例如, Windows SDK包含文件操作, GUI, 设备管理, 网络通信, 线程控制等操作系统级别的API
:::

### GCC

在Linux平台上, GCC(GNU Compiler Collection)是最常用的编译工具链. 最早的GCC是"GNU C Compiler"的缩写, 专用于C语言. 随着发展, 它支持了多种编程语言, 因此改名为GNU Compiler Collection.

GCC包含多个子工具和库, 以支持从源代码到可执行文件的整个编译和构建流程:

- gcc-core: GCC的核心编译器, 用于执行代码的预处理, 编译, 最终将C/C++代码转换为汇编代码
- Binutils: 一组辅助工具, 包含:
    - ld: 链接器, 用于将多个目标文件和库文件合并为一个可执行文件
    - as: 汇编器, 用于将汇编代码转换为机器代码
    - readelf: 目标文件查看器, 用于查看二进制文件的详细信息
- glibc: GNU C库, 包含了C标准库的基本函数实现, 如`printf`, `malloc`等, 这些函数为C/C++程序提供了标准的输入输出, 内存管理等功能.

使用GCC编译的流程: `gcc hello.c -o hello`. 这段代码其实执行了两个步骤, 编译, 调用内部的`cc`编译器, 生成目标文件; 链接, 调用`ld`链接器, 将目标文件和标准库链接, 生成可执行文件. 可以使用`-c`参数让`gcc`只编译不链接, 也可以直接调用`cc`和`ld`来分别完成编译和链接操作.

<br>

> [1] 面试高频问题之C++编译过程_c++_小万哥_InfoQ写作社区. (不详). 取读于 2024年11月11日, 从 https://xie.infoq.cn/article/ebda02316941c2141fcc5c4b5
>
> [2] C与CPP常见编译工具链与构建系统简介 - w4ngzhen - 博客园. (不详). 取读于 2024年11月11日, 从 https://www.cnblogs.com/w4ngzhen/p/17695080.html